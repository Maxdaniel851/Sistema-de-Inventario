<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario - Materia Prima</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0f0f23 75%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Part铆culas flotantes animadas */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: linear-gradient(45deg, #9b59b6, #663399);
            border-radius: 50%;
            opacity: 0.6;
            animation: float 6s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 4px; height: 4px; left: 10%; animation-delay: 0s; animation-duration: 8s; }
        .particle:nth-child(2) { width: 6px; height: 6px; left: 20%; animation-delay: 1s; animation-duration: 7s; }
        .particle:nth-child(3) { width: 3px; height: 3px; left: 30%; animation-delay: 2s; animation-duration: 9s; }
        .particle:nth-child(4) { width: 5px; height: 5px; left: 40%; animation-delay: 0.5s; animation-duration: 6s; }
        .particle:nth-child(5) { width: 4px; height: 4px; left: 50%; animation-delay: 3s; animation-duration: 8s; }

        @keyframes float {
            0%, 100% { 
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10%, 90% {
                opacity: 0.6;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 1;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.5),
                0 0 0 1px rgba(155, 89, 182, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.5),
                0 0 20px rgba(155, 89, 182, 0.5);
            position: relative;
            z-index: 1;
        }

        .header p {
            position: relative;
            z-index: 1;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
            background: rgba(26, 26, 46, 0.7);
        }

        .section {
            margin-bottom: 50px;
            padding: 30px;
            background: linear-gradient(145deg, #2c2c54 0%, #1a1a2e 100%);
            border-radius: 20px;
            border: 1px solid rgba(155, 89, 182, 0.3);
            box-shadow: 
                0 15px 30px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.4),
                0 0 20px rgba(155, 89, 182, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .section h2 {
            color: #e6e6ff;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
        }

        .action-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .action-card.active {
            border-color: #9b59b6;
            box-shadow: 
                0 0 30px rgba(155, 89, 182, 0.5),
                inset 0 0 20px rgba(155, 89, 182, 0.1);
            transform: scale(1.02);
        }

        .action-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.3);
        }

        .action-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .action-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #e6e6ff;
            margin-bottom: 10px;
        }

        .action-description {
            color: #b3b3e6;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #b3b3e6;
            font-size: 1.1em;
        }

        input, select, button {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            color: #e6e6ff;
        }

        /* Estilos espec铆ficos para select */
        select {
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            color: #e6e6ff;
        }

        select option {
            background: #2c2c54;
            color: #e6e6ff;
            padding: 10px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #9b59b6;
            box-shadow: 
                0 0 0 3px rgba(155, 89, 182, 0.2),
                0 0 20px rgba(155, 89, 182, 0.3);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: #8a8ab3;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 25px rgba(155, 89, 182, 0.4),
                0 0 20px rgba(155, 89, 182, 0.3);
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, #2c2c54 0%, #1e1e3f 100%);
            border: 2px solid #9b59b6;
            border-top: none;
            border-radius: 0 0 15px 15px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .dropdown-option {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
            color: #b3b3e6;
            transition: all 0.3s ease;
        }

        .dropdown-option:hover {
            background: linear-gradient(90deg, rgba(155, 89, 182, 0.2), rgba(155, 89, 182, 0.1));
            color: #e6e6ff;
        }

        .dropdown-header {
            padding: 12px 15px;
            background: linear-gradient(90deg, #663399, #9b59b6);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-card {
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 
                0 8px 25px rgba(102, 51, 153, 0.4),
                0 0 0 1px rgba(155, 89, 182, 0.3);
        }

        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .product-card {
            background: linear-gradient(145deg, #2c2c54 0%, #1e1e3f 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(155, 89, 182, 0.2);
            transition: all 0.4s ease;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.4),
                0 0 30px rgba(155, 89, 182, 0.3);
        }

        .product-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #e6e6ff;
            margin-bottom: 15px;
        }

        .product-quantity {
            font-size: 1.2em;
            color: #9b59b6;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .ingredients-list {
            margin-top: 15px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
            color: #b3b3e6;
        }

        .totals-section {
            background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 50%, #7b1fa2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-top: 40px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .total-item {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .total-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .total-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #8a8ab3;
            font-style: italic;
            font-size: 1.1em;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8e24aa 0%, #9c27b0 50%, #7b1fa2 100%);
            color: white;
            width: auto;
            padding: 12px 20px;
            margin-top: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #9b59b6;
            animation: loading-spin 1s ease-in-out infinite;
        }

        @keyframes loading-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .products-list {
                grid-template-columns: 1fr;
            }
            
            .totals-grid {
                grid-template-columns: 1fr;
            }

            .action-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Part铆culas flotantes -->
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Sistema de Inventario</h1>
            <p>Control de Materia Prima a Productos Finalizados</p>
        </div>

        <div class="main-content">
            <!-- Estado de conexi贸n -->
            <div class="status-card">
                <span></span>
                <span>Conectado a Google Sheets - Los datos se guardan autom谩ticamente</span>
            </div>

            <!-- Selector de Acci贸n -->
            <div class="section">
                <h2> Seleccione una Acci贸n</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Elija si desea preparar productos con f贸rmula o empacar productos directos.</p>
                
                <div class="action-selector">
                    <div class="action-card" onclick="selectAction('prepare')">
                        <span class="action-icon">锔</span>
                        <div class="action-title">Preparar</div>
                        <div class="action-description">Productos con f贸rmula que requieren preparaci贸n y mezcla de ingredientes</div>
                    </div>
                    
                    <div class="action-card" onclick="selectAction('package')">
                        <span class="action-icon"></span>
                        <div class="action-title">Empacar</div>
                        <div class="action-description">Productos de empaque directo en relaci贸n 1:1</div>
                    </div>
                </div>
            </div>

            <!-- Formulario de preparaci贸n -->
            <div class="section form-container" id="prepareForm">
                <h2>锔 Preparar Productos</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Complete los campos para registrar la preparaci贸n de productos con f贸rmula.</p>
                
                <div class="form-group">
                    <label for="prepareProductSearch">Producto a Preparar:</label>
                    <div style="position: relative;">
                        <input type="text" id="prepareProductSearch" placeholder="Haga clic para seleccionar producto..." autocomplete="off" readonly required>
                        <div id="prepareProductDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPrepareProduct">
                </div>
                
                <div class="form-group">
                    <label for="prepareProductPresentation">Presentaci贸n:</label>
                    <select id="prepareProductPresentation" required>
                        <option value="">Primero seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group" id="prepareFragranceGroup" style="display: none;">
                    <label for="prepareFragranceSearch">Fragancia:</label>
                    <div style="position: relative;">
                        <input type="text" id="prepareFragranceSearch" placeholder="Haga clic para seleccionar fragancia..." autocomplete="off" readonly>
                        <div id="prepareFragranceDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPrepareFragrance">
                </div>
                
                <div class="form-group">
                    <label for="prepareProductQuantity">Cantidad a Preparar:</label>
                    <input type="number" id="prepareProductQuantity" placeholder="驴Cu谩ntas unidades se van a preparar?" min="1" required>
                </div>
                
                <div style="display: flex; justify-content: center;">
                    <button class="btn" onclick="addPrepareProduct()">
                        <span id="prepareSaveButtonText">Registrar Preparaci贸n</span>
                    </button>
                </div>
                
                <div id="prepareSaveStatus" style="margin-top: 20px;"></div>
            </div>

            <!-- Formulario de empaque -->
            <div class="section form-container" id="packageForm">
                <h2> Empacar Productos</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Complete los campos para registrar el empaque de productos directos.</p>
                
                <div class="form-group">
                    <label for="packageProductSearch">Producto a Empacar:</label>
                    <div style="position: relative;">
                        <input type="text" id="packageProductSearch" placeholder="Haga clic para seleccionar producto..." autocomplete="off" readonly required>
                        <div id="packageProductDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPackageProduct">
                </div>
                
                <div class="form-group">
                    <label for="packageProductPresentation">Presentaci贸n:</label>
                    <select id="packageProductPresentation" required>
                        <option value="">Primero seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="packageProductQuantity">Cantidad a Empacar:</label>
                    <input type="number" id="packageProductQuantity" placeholder="驴Cu谩ntas unidades se van a empacar?" min="1" required>
                </div>
                
                <div style="display: flex; justify-content: center;">
                    <button class="btn" onclick="addPackageProduct()">
                        <span id="packageSaveButtonText">Registrar Empaque</span>
                    </button>
                </div>
                
                <div id="packageSaveStatus" style="margin-top: 20px;"></div>
            </div>

            <!-- Lista de productos -->
            <div class="section">
                <h2> Producci贸n Registrada</h2>
                <div id="productsList" class="products-list">
                    <div class="empty-state">
                        <p>No hay producci贸n registrada. Seleccione una acci贸n arriba para empezar.</p>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="totals-section">
                <h2> Resumen Total de Materia Prima</h2>
                <div class="totals-grid">
                    <div class="total-item">
                        <div class="total-value" id="totalProducts">0</div>
                        <div class="total-label">Productos Finalizados</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="totalRawMaterials">0</div>
                        <div class="total-label">Tipos de Materia Prima</div>
                    </div>
                </div>
                <div id="rawMaterialsBreakdown"></div>
            </div>
        </div>
    </div>

    <script>
        // URL fija de Google Sheets
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwKijWeDxf279_nBRjFcBfJTEmJc4150kRFIMN8BsJX7z6TaAv_4djupBhomOrpA48-Zw/exec';
        
        // Variables globales
        let products = [];
        let dailyProduction = {};
        let currentAction = null;
        
        // Funci贸n para obtener unidades para productos de empaque
        function getUnitForPackaging(productName, presentation) {
            const packagingUnits = {
                'Gal贸n': 'gal贸n',
                '20Lts': 'litros',
                'Litro': 'litro',
                '1/2 Litro': 'litro',
                'Kg': 'kg',
                '1/2 Kg': 'kg'
            };
            return packagingUnits[presentation] || 'unidades';
        }
        
        // F贸rmulas preconfiguradas
        const formulas = {
            "AMBIENTADOR CONCENTRADO (1L)": [
                { name: "Fragancia", quantity: 110 },
                { name: "Nonil Fenol", quantity: 70 },
                { name: "Dodigen", quantity: 10 },
                { name: "Alcohol Et铆lico", quantity: 240 },
                { name: "Agua", quantity: 570 }
            ],
            "AMBIENTADOR CONCENTRADO (1 GALN)": [
                { name: "Fragancia", quantity: 440 },
                { name: "Nonil Fenol", quantity: 280 },
                { name: "Dodigen", quantity: 40 },
                { name: "Alcohol Et铆lico", quantity: 960 },
                { name: "Agua", quantity: 2065 }
            ],
            "SILICONA (60ml)": [
                { name: "Silicona", quantity: 30 },
                { name: "Agua", quantity: 30 }
            ],
            "LLANTN (1L)": [
                { name: "Glicerina", quantity: 500 },
                { name: "Silicona", quantity: 50 },
                { name: "Procide", quantity: 7.5 },
                { name: "Color Azul", quantity: 8 },
                { name: "Agua", quantity: 434.5 }
            ],
            "LLANTN (20L)": [
                { name: "Glicerina", quantity: 2500 },
                { name: "Silicona", quantity: 250 },
                { name: "Procide", quantity: 35 },
                { name: "Color Azul", quantity: 30 },
                { name: "Agua", quantity: 17185 }
            ],
            "LIMPIDO AL 5% (1 GALN)": [
                { name: "Hipoclorito de Sodio al 13%", quantity: 1500 },
                { name: "Agua", quantity: 2285 }
            ],
            "LIMPIDO AL 5% (20L)": [
                { name: "Hipoclorito de Sodio al 13%", quantity: 8000 },
                { name: "Agua", quantity: 12000 }
            ],
            "DESENGRASANTE (1 GALN)": [
                { name: "Agua", quantity: 1400 },
                { name: "Soda en Escama", quantity: 60 },
                { name: "cido Sulf贸nico", quantity: 400 },
                { name: "Varsol", quantity: 308 },
                { name: "Nonil", quantity: 400 },
                { name: "Citronela", quantity: 10 },
                { name: "Color Amarillo", quantity: 5 }
            ],
            "DESENGRASANTE (20L)": [
                { name: "Agua", quantity: 10000 },
                { name: "Soda en Escama", quantity: 300 },
                { name: "cido Sulf贸nico", quantity: 2000 },
                { name: "Varsol", quantity: 1530 },
                { name: "Nonil", quantity: 2000 },
                { name: "Citronela", quantity: 60 },
                { name: "Color Amarillo", quantity: 20 }
            ],
            "DETERGENTE DE MANOS (1L)": [
                { name: "Agua", quantity: 300 },
                { name: "Procide", quantity: 2 },
                { name: "Genapol al 70%", quantity: 100 },
                { name: "Beta铆na", quantity: 50 },
                { name: "Fragancia", quantity: 5 },
                { name: "Sal", quantity: 20 },
                { name: "Color", quantity: 2 }
            ],
            "DETERGENTE DE MANOS (20L)": [
                { name: "Agua", quantity: 10000 },
                { name: "Procide", quantity: 40 },
                { name: "Genapol al 70%", quantity: 2000 },
                { name: "Beta铆na", quantity: 1000 },
                { name: "Fragancia", quantity: 60 },
                { name: "Sal", quantity: 500 },
                { name: "Color", quantity: 30 }
            ],
            "LIMPIAVIDRIOS (1L)": [
                { name: "Agua", quantity: 916 },
                { name: "Alcohol Prop铆lico", quantity: 64 },
                { name: "Genapol", quantity: 5 },
                { name: "Butil Glicol", quantity: 15 },
                { name: "Fragancia Brisa Marina", quantity: 5 },
                { name: "Color", quantity: 2 }
            ],
            "LIMPIAVIDRIOS (1 GALN)": [
                { name: "Agua", quantity: 3664 },
                { name: "Alcohol Prop铆lico", quantity: 256 },
                { name: "Genapol", quantity: 20 },
                { name: "Butil Glicol", quantity: 60 },
                { name: "Fragancia Brisa Marina", quantity: 20 },
                { name: "Color", quantity: 8 }
            ],
            "LIMPIAVIDRIOS (20L)": [
                { name: "Agua", quantity: 18320 },
                { name: "Alcohol Prop铆lico", quantity: 1280 },
                { name: "Genapol", quantity: 100 },
                { name: "Butil Glicol", quantity: 300 },
                { name: "Fragancia Brisa Marina", quantity: 100 },
                { name: "Color", quantity: 40 }
            ],
            "DESINFECTANTE (1L)": [
                { name: "Fragancia", quantity: 20 },
                { name: "Nonil", quantity: 30 },
                { name: "Dodigen", quantity: 10 },
                { name: "Color", quantity: 3 },
                { name: "Agua", quantity: 937 }
            ],
            "DESINFECTANTE (1 GALN)": [
                { name: "Fragancia", quantity: 80 },
                { name: "Nonil", quantity: 120 },
                { name: "Dodigen", quantity: 40 },
                { name: "Color", quantity: 10 },
                { name: "Agua", quantity: 3535 }
            ],
            "DESINFECTANTE (20L)": [
                { name: "Fragancia", quantity: 330 },
                { name: "Nonil", quantity: 600 },
                { name: "Dodigen", quantity: 200 },
                { name: "Color", quantity: 50 },
                { name: "Agua", quantity: 18820 }
            ],
            "DESINFECTANTE CANELA/LIMN (20L)": [
                { name: "Fragancia", quantity: 330 },
                { name: "Nonil", quantity: 750 },
                { name: "Dodigen", quantity: 200 },
                { name: "Color", quantity: 50 },
                { name: "Agua", quantity: 18670 }
            ],
            "RESTAURADOR DE PARTES NEGRAS (1L)": [
                { name: "Glicerina", quantity: 600 },
                { name: "Silicona", quantity: 25 },
                { name: "Procide", quantity: 2.5 },
                { name: "Fragancia Aylen", quantity: 5 },
                { name: "Color Rojo Claro", quantity: 3 },
                { name: "Agua", quantity: 364.5 }
            ],
            "RESTAURADOR DE PARTES NEGRAS (1 GALN)": [
                { name: "Glicerina", quantity: 2500 },
                { name: "Silicona", quantity: 100 },
                { name: "Procide", quantity: 40 },
                { name: "Fragancia Aylen", quantity: 20 },
                { name: "Color Rojo Claro", quantity: 10 },
                { name: "Agua", quantity: 1115 }
            ],
            "DETERGENTE LQUIDO (20L)": [
                { name: "Agua", quantity: 10000 },
                { name: "Soda en Escama", quantity: 560 },
                { name: "cido Sulf贸nico", quantity: 4000 },
                { name: "Procide", quantity: 40 },
                { name: "Beta铆na", quantity: 100 }
            ],
            "SHAMPOO POLARIZADO (20L)": [
                { name: "Genapol al 70%", quantity: 1800 },
                { name: "Beta铆na", quantity: 800 },
                { name: "Cocoamida", quantity: 400 },
                { name: "Procide", quantity: 40 },
                { name: "Sal", quantity: 200 },
                { name: "Fragancia Pi帽a Colada", quantity: 60 },
                { name: "Color", quantity: 30 },
                { name: "Agua", quantity: 16670 }
            ],
            "SHAMPOO VEHCULO (40L)": [
                { name: "Agua", quantity: 15000 },
                { name: "NaOH (Soda)", quantity: 225 },
                { name: "cido Sulf贸nico", quantity: 1600 },
                { name: "Genapol AL70%", quantity: 1600 },
                { name: "Procide", quantity: 70 },
                { name: "Beta铆na", quantity: 500 },
                { name: "Sal X Libra", quantity: 2 },
                { name: "Color Amarillo", quantity: 8 }
            ],
            "SHAMPOO VEHCULO (80L)": [
                { name: "Agua", quantity: 71198 },
                { name: "NaOH (Soda)", quantity: 450 },
                { name: "cido Sulf贸nico", quantity: 3200 },
                { name: "Genapol AL70%", quantity: 3200 },
                { name: "Procide", quantity: 140 },
                { name: "Beta铆na", quantity: 1000 },
                { name: "Sal", quantity: 1600 },
                { name: "Color Amarillo", quantity: 80 }
            ],
            "SHAMPOO VEHCULO (160L)": [
                { name: "Agua", quantity: 142398 },
                { name: "NaOH (Soda)", quantity: 900 },
                { name: "cido Sulf贸nico", quantity: 6400 },
                { name: "Genapol AL70%", quantity: 6400 },
                { name: "Procide", quantity: 280 },
                { name: "Beta铆na", quantity: 2000 },
                { name: "Sal", quantity: 1600 },
                { name: "Color Amarillo", quantity: 160 }
            ]
        };

        // Lista de productos disponibles
        const allProducts = [
            // Productos con f贸rmulas
            { name: "AMBIENTADOR CONCENTRADO", type: "formula", presentations: ["1L", "1 GALN"], needsFragrance: true },
            { name: "SILICONA", type: "formula", presentations: ["60ml"], needsFragrance: false },
            { name: "LLANTN", type: "formula", presentations: ["1L", "20L"], needsFragrance: false },
            { name: "LIMPIDO AL 5%", type: "formula", presentations: ["1 GALN", "20L"], needsFragrance: false },
            { name: "DESENGRASANTE", type: "formula", presentations: ["1 GALN", "20L"], needsFragrance: false },
            { name: "DETERGENTE DE MANOS", type: "formula", presentations: ["1L", "20L"], needsFragrance: false },
            { name: "LIMPIAVIDRIOS", type: "formula", presentations: ["1L", "1 GALN", "20L"], needsFragrance: false },
            { name: "DESINFECTANTE", type: "formula", presentations: ["1L", "1 GALN", "20L"], needsFragrance: true },
            { name: "DESINFECTANTE CANELA/LIMN", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "RESTAURADOR DE PARTES NEGRAS", type: "formula", presentations: ["1L", "1 GALN"], needsFragrance: false },
            { name: "DETERGENTE LQUIDO", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "SHAMPOO POLARIZADO", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "SHAMPOO VEHCULO", type: "formula", presentations: ["40L", "80L", "160L"], needsFragrance: false },
            
            // Productos de empaque
            { name: "cido n铆trico", type: "packaging", presentations: ["Gal贸n"], needsFragrance: false },
            { name: "cido sulf贸nico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Alcohol cet铆lico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Alcohol et铆lico", type: "packaging", presentations: ["Litro", "Gal贸n", "20Lts"], needsFragrance: false },
            { name: "Alcohol desodorizado", type: "packaging", presentations: ["Litro"], needsFragrance: false },
            { name: "Alcohol prop铆lico", type: "packaging", presentations: ["Gal贸n", "Litro"], needsFragrance: false },
            { name: "Beta铆na", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Butil glicol", type: "packaging", presentations: ["Litro", "1/2 Litro"], needsFragrance: false },
            { name: "Cocoamida", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Creolina", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Dodigen", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Genapol 70%", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Glicerina", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Hipoclorito de sodio", type: "packaging", presentations: ["20Lts", "Gal贸n", "Litro", "Kg"], needsFragrance: false },
            { name: "Nonil", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Procide", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Rinsol", type: "packaging", presentations: ["Kg", "1/2 Kg"], needsFragrance: false },
            { name: "Silicona antiespumante", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Silicona emulsi贸n", type: "packaging", presentations: ["Kg", "1/2 Kg"], needsFragrance: false },
            { name: "Soda", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Sensableach", type: "packaging", presentations: ["Litro"], needsFragrance: false },
            { name: "Varsol", type: "packaging", presentations: ["1/2 Litro", "Gal贸n", "Litro"], needsFragrance: false },
            { name: "Tpf (tripolifosfato)", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "cido c铆trico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "cido ox谩lico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Antiincrustante", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Bicarbonato de sodio", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Bisulfito de sodio", type: "packaging", presentations: ["Kg"], needsFragrance: false }
        ];

        // Lista de fragancias
        const fragrances = [
            "Fragancia Ailyn",
            "Fragancia Algod贸n",
            "Fragancia Bamboo",
            "Fragancia Brisa Del Mar",
            "Fragancia Brisa Del Campo",
            "Fragancia Brisa Marina",
            "Fragancia Caf茅",
            "Fragancia Canela",
            "Fragancia Carro Nuevo",
            "Fragancia Cherry (Cereza)",
            "Fragancia Chicle",
            "Fragancia Citronela",
            "Fragancia Durazno",
            "Fragancia Flor De Amoha",
            "Fragancia Fresa",
            "Fragancia Frutal",
            "Fragancia Jardin",
            "Fragancia Lavanda Fabulosa",
            "Fragancia Lima Limon",
            "Fragancia Liquid Touch",
            "Fragancia Limon Peel",
            "Fragancia Magic Flowers",
            "Fragancia Mandarina",
            "Fragancia Manzana",
            "Fragancia Maracuya",
            "Fragancia Patilla Melon",
            "Fragancia Pino Navidad",
            "Fragancia Pi帽a",
            "Fragancia Rosa",
            "Fragancia Sierra Nevada",
            "Fragancia Talco",
            "Fragancia Uva",
            "Fragancia Vainilla"
        ];

        // Funci贸n para seleccionar acci贸n
        function selectAction(action) {
            currentAction = action;
            
            // Remover clase active de todas las tarjetas
            document.querySelectorAll('.action-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Ocultar todos los formularios
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.remove('active');
            });
            
            if (action === 'prepare') {
                document.querySelector('.action-card:first-child').classList.add('active');
                document.getElementById('prepareForm').classList.add('active');
            } else if (action === 'package') {
                document.querySelector('.action-card:last-child').classList.add('active');
                document.getElementById('packageForm').classList.add('active');
            }
        }

        // Configurar selector de productos para PREPARAR
        function setupPrepareProductSearch() {
            const searchInput = document.getElementById('prepareProductSearch');
            const dropdown = document.getElementById('prepareProductDropdown');
            const hiddenInput = document.getElementById('selectedPrepareProduct');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                
                const formulaProducts = allProducts.filter(p => p.type === 'formula');
                
                formulaProducts.forEach(product => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = product.name;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = product.name;
                        hiddenInput.value = product.name;
                        dropdown.style.display = 'none';
                        updatePreparePresentations();
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Configurar selector de productos para EMPACAR
        function setupPackageProductSearch() {
            const searchInput = document.getElementById('packageProductSearch');
            const dropdown = document.getElementById('packageProductDropdown');
            const hiddenInput = document.getElementById('selectedPackageProduct');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                
                const packagingProducts = allProducts.filter(p => p.type === 'packaging');
                
                packagingProducts.forEach(product => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = product.name;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = product.name;
                        hiddenInput.value = product.name;
                        dropdown.style.display = 'none';
                        updatePackagePresentations();
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Configurar selector de fragancias
        function setupPrepareFragranceSearch() {
            const searchInput = document.getElementById('prepareFragranceSearch');
            const dropdown = document.getElementById('prepareFragranceDropdown');
            const hiddenInput = document.getElementById('selectedPrepareFragrance');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                fragrances.forEach(fragrance => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = fragrance;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = fragrance;
                        hiddenInput.value = fragrance;
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(option);
                });
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Actualizar presentaciones para PREPARAR
        function updatePreparePresentations() {
            const selectedProductName = document.getElementById('selectedPrepareProduct').value;
            const presentationSelect = document.getElementById('prepareProductPresentation');
            const fragranceGroup = document.getElementById('prepareFragranceGroup');
            
            presentationSelect.innerHTML = '';
            
            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (selectedProduct && selectedProduct.needsFragrance) {
                fragranceGroup.style.display = 'block';
            } else {
                fragranceGroup.style.display = 'none';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
            }
            
            if (!selectedProduct) {
                presentationSelect.innerHTML = '<option value="">Primero seleccione un producto</option>';
                return;
            }
            
            const availablePresentations = selectedProduct.presentations || [];
            
            if (availablePresentations.length === 0) {
                presentationSelect.innerHTML = '<option value="">No hay presentaciones disponibles</option>';
                return;
            }
            
            presentationSelect.innerHTML = '<option value="">Seleccione una presentaci贸n</option>';
            
            availablePresentations.forEach(presentation => {
                const option = document.createElement('option');
                option.value = presentation;
                option.textContent = presentation;
                presentationSelect.appendChild(option);
            });
        }

        // Actualizar presentaciones para EMPACAR
        function updatePackagePresentations() {
            const selectedProductName = document.getElementById('selectedPackageProduct').value;
            const presentationSelect = document.getElementById('packageProductPresentation');
            
            presentationSelect.innerHTML = '';
            
            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (!selectedProduct) {
                presentationSelect.innerHTML = '<option value="">Primero seleccione un producto</option>';
                return;
            }
            
            const availablePresentations = selectedProduct.presentations || [];
            
            if (availablePresentations.length === 0) {
                presentationSelect.innerHTML = '<option value="">No hay presentaciones disponibles</option>';
                return;
            }
            
            presentationSelect.innerHTML = '<option value="">Seleccione una presentaci贸n</option>';
            
            availablePresentations.forEach(presentation => {
                const option = document.createElement('option');
                option.value = presentation;
                option.textContent = presentation;
                presentationSelect.appendChild(option);
            });
        }

        // Funci贸n para enviar datos a Google Sheets
        async function sendToGoogleSheets(productData) {
            // Construir el nombre de la f贸rmula basado en el producto y presentaci贸n
            let formulaKey = `${productData.name.split(' (')[0]} (${productData.name.match(/\(([^)]+)\)/)?.[1] || ''})`;
            
            const formula = formulas[formulaKey];
            if (!formula) {
                console.error('F贸rmula no encontrada para:', formulaKey);
                console.log('F贸rmulas disponibles:', Object.keys(formulas));
                throw new Error(`F贸rmula no encontrada para el producto: ${formulaKey}`);
            }

            const records = [];
            const currentTime = new Date().toLocaleTimeString('es-ES');

            formula.forEach(ingredient => {
                const totalNeeded = ingredient.quantity * productData.quantity;
                records.push({
                    date: productData.date,
                    time: currentTime,
                    employee: 'Sistema',
                    product: productData.name.split(' (')[0],
                    presentation: productData.name.match(/\(([^)]+)\)/)?.[1] || '',
                    fragrance: productData.fragrance || 'N/A',
                    quantity: productData.quantity,
                    material: ingredient.name,
                    materialQuantity: totalNeeded.toFixed(2),
                    unit: getUnit(ingredient.name)
                });
            });

            const response = await fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ records })
            });

            return { success: true };
        }

        // Agregar producto PREPARAR
        async function addPrepareProduct() {
            const selectedProductName = document.getElementById('selectedPrepareProduct').value;
            const presentation = document.getElementById('prepareProductPresentation').value;
            const quantity = parseInt(document.getElementById('prepareProductQuantity').value);
            const selectedFragrance = document.getElementById('selectedPrepareFragrance').value;
            const date = new Date().toISOString().split('T')[0];

            if (!selectedProductName || !presentation || !quantity || quantity <= 0) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }

            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (selectedProduct && selectedProduct.needsFragrance && !selectedFragrance) {
                alert('Por favor, seleccione una fragancia para este producto.');
                return;
            }
            
            let fullProductName = `${selectedProductName} (${presentation})`;
            if (selectedFragrance) {
                fullProductName += ` - ${selectedFragrance}`;
            }
            
            const productRecord = {
                name: fullProductName,
                quantity: quantity,
                date: date,
                timestamp: new Date().toISOString(),
                employee: 'Sistema',
                fragrance: selectedFragrance || null,
                productType: selectedProduct.type,
                action: 'prepare'
            };

            const saveButton = document.getElementById('prepareSaveButtonText');
            const statusDiv = document.getElementById('prepareSaveStatus');
            
            saveButton.innerHTML = '<span class="loading-spinner"></span> Guardando...';
            statusDiv.innerHTML = '<div style="color: #9b59b6;"> Enviando datos a Google Sheets...</div>';

            try {
                await sendToGoogleSheets(productRecord);
                
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                // Limpiar formulario
                document.getElementById('prepareProductSearch').value = '';
                document.getElementById('selectedPrepareProduct').value = '';
                document.getElementById('prepareProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('prepareProductQuantity').value = '';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
                document.getElementById('prepareFragranceGroup').style.display = 'none';
                
                saveButton.textContent = '隆Guardado!';
                statusDiv.innerHTML = `<div style="color: #9b59b6;"> ${fullProductName} preparado exitosamente: ${quantity} unidades</div>`;
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Preparaci贸n';
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                saveButton.textContent = '锔 Guardado Local';
                statusDiv.innerHTML = `<div style="color: #ff9500;">锔 Error conectando con Google Sheets. Datos guardados localmente.</div>`;
                
                // Limpiar formulario
                document.getElementById('prepareProductSearch').value = '';
                document.getElementById('selectedPrepareProduct').value = '';
                document.getElementById('prepareProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('prepareProductQuantity').value = '';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
                document.getElementById('prepareFragranceGroup').style.display = 'none';
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Preparaci贸n';
                }, 3000);
            }
        }

        // Agregar producto EMPACAR
        async function addPackageProduct() {
            const selectedProductName = document.getElementById('selectedPackageProduct').value;
            const presentation = document.getElementById('packageProductPresentation').value;
            const quantity = parseInt(document.getElementById('packageProductQuantity').value);
            const date = new Date().toISOString().split('T')[0];

            if (!selectedProductName || !presentation || !quantity || quantity <= 0) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }

            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            let fullProductName = `${selectedProductName} (${presentation})`;
            
            const productRecord = {
                name: fullProductName,
                quantity: quantity,
                date: date,
                timestamp: new Date().toISOString(),
                employee: 'Sistema',
                fragrance: null,
                productType: selectedProduct.type,
                action: 'package'
            };

            const saveButton = document.getElementById('packageSaveButtonText');
            const statusDiv = document.getElementById('packageSaveStatus');
            
            saveButton.innerHTML = '<span class="loading-spinner"></span> Guardando...';
            statusDiv.innerHTML = '<div style="color: #9b59b6;"> Registrando empaque...</div>';

            try {
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                // Limpiar formulario
                document.getElementById('packageProductSearch').value = '';
                document.getElementById('selectedPackageProduct').value = '';
                document.getElementById('packageProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('packageProductQuantity').value = '';
                
                saveButton.textContent = '隆Empacado!';
                statusDiv.innerHTML = `<div style="color: #9b59b6;"> ${fullProductName} empacado exitosamente: ${quantity} unidades</div>`;
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Empaque';
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                saveButton.textContent = '锔 Error';
                statusDiv.innerHTML = `<div style="color: #ff9500;">锔 Error: ${error.message}</div>`;
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Empaque';
                }, 3000);
            }
        }

        // Funci贸n para obtener unidades
        function getUnit(ingredientName) {
            const units = {
                'Agua': 'ml',
                'Fragancia': 'ml',
                'Nonil Fenol': 'ml',
                'Nonil': 'ml',
                'Dodigen': 'ml',
                'Alcohol Et铆lico': 'ml',
                'Alcohol Prop铆lico': 'ml',
                'Silicona': 'ml',
                'Glicerina': 'ml',
                'Procide': 'ml',
                'Butil Glicol': 'ml',
                'Fragancia Brisa Marina': 'ml',
                'Fragancia Aylen': 'ml',
                'Fragancia Pi帽a Colada': 'ml',
                'Hipoclorito de Sodio al 13%': 'ml',
                'Genapol al 70%': 'g',
                'Genapol': 'ml',
                'Genapol AL70%': 'g',
                'Beta铆na': 'g',
                'Cocoamida': 'g',
                'Soda en Escama': 'g',
                'NaOH (Soda)': 'g',
                'cido Sulf贸nico': 'g',
                'Varsol': 'g',
                'Citronela': 'g',
                'Sal': 'g',
                'Sal X Libra': 'g',
                'Color': 'ml',
                'Color Azul': 'ml',
                'Color Rojo Claro': 'ml',
                'Color Amarillo': 'ml'
            };
            return units[ingredientName] || 'unidades';
        }

        // Actualizar lista de productos
        function updateProductsList(productsToShow = products) {
            const container = document.getElementById('productsList');
            
            if (productsToShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay producci贸n registrada. Seleccione una acci贸n arriba para empezar.</p></div>';
                return;
            }

            container.innerHTML = '';
            
            const productsByDate = {};
            productsToShow.forEach(product => {
                if (!productsByDate[product.date]) {
                    productsByDate[product.date] = [];
                }
                productsByDate[product.date].push(product);
            });

            Object.keys(productsByDate).sort().reverse().forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.style.cssText = `
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    margin: 25px 0 15px 0;
                    font-size: 1.3em;
                    font-weight: 600;
                    text-align: center;
                `;
                dateHeader.textContent = ` ${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
                container.appendChild(dateHeader);

                productsByDate[date].forEach((product, index) => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    
                    let formulaHTML = '';
                    let actionBadge = '';
                    
                    if (product.action === 'prepare') {
                        actionBadge = '<div style="display: inline-block; background: linear-gradient(45deg, #663399, #9b59b6); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px;">锔 PREPARADO</div>';
                    } else if (product.action === 'package') {
                        actionBadge = '<div style="display: inline-block; background: linear-gradient(45deg, #8e24aa, #9c27b0); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px;"> EMPACADO</div>';
                    }
                    
                    const selectedProduct = allProducts.find(p => p.name === product.name.split(' (')[0]);
                    
                    if (selectedProduct && selectedProduct.type === 'packaging') {
                        const productName = selectedProduct.name;
                        const presentation = product.name.match(/\(([^)]+)\)/)?.[1] || '';
                        const unit = getUnitForPackaging(productName, presentation);
                        
                        formulaHTML = `
                            <h4 style="margin-top: 20px; color: #b3b3e6;"> Producto de Empaque:</h4>
                            <div class="ingredients-list">
                                <div class="ingredient-item">
                                    <span>${productName}</span>
                                    <span>1:1 ratio</span>
                                </div>
                            </div>
                            <h4 style="margin-top: 20px; color: #9b59b6;"> Total empacado:</h4>
                            <div class="ingredients-list">
                                <div class="ingredient-item">
                                    <span><strong>${productName}</strong></span>
                                    <span><strong>${product.quantity} ${unit}</strong></span>
                                </div>
                            </div>
                        `;
                    } else if (formulas[product.name]) {
                        const totalIngredients = {};
                        
                        formulas[product.name].forEach(ingredient => {
                            const totalNeeded = ingredient.quantity * product.quantity;
                            totalIngredients[ingredient.name] = totalNeeded;
                        });
                        
                        formulaHTML = `
                            <h4 style="margin-top: 20px; color: #b3b3e6;">锔 F贸rmula por unidad:</h4>
                            <div class="ingredients-list">
                                ${formulas[product.name].map(ing => `
                                    <div class="ingredient-item">
                                        <span>${ing.name}</span>
                                        <span>${ing.quantity} ${getUnit(ing.name)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <h4 style="margin-top: 20px; color: #9b59b6;">М Total requerido:</h4>
                            <div class="ingredients-list">
                                ${Object.entries(totalIngredients).map(([name, total]) => `
                                    <div class="ingredient-item">
                                        <span><strong>${name}</strong></span>
                                        <span><strong>${total.toFixed(2)} ${getUnit(name)}</strong></span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        // Intentar buscar la f贸rmula con el nombre del producto base + presentaci贸n
                        const productBaseName = product.name.split(' (')[0];
                        const presentation = product.name.match(/\(([^)]+)\)/)?.[1] || '';
                        const formulaKey = `${productBaseName} (${presentation})`;
                        
                        if (formulas[formulaKey]) {
                            const totalIngredients = {};
                            
                            formulas[formulaKey].forEach(ingredient => {
                                const totalNeeded = ingredient.quantity * product.quantity;
                                totalIngredients[ingredient.name] = totalNeeded;
                            });
                            
                            formulaHTML = `
                                <h4 style="margin-top: 20px; color: #b3b3e6;">锔 F贸rmula por unidad:</h4>
                                <div class="ingredients-list">
                                    ${formulas[formulaKey].map(ing => `
                                        <div class="ingredient-item">
                                            <span>${ing.name}</span>
                                            <span>${ing.quantity} ${getUnit(ing.name)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <h4 style="margin-top: 20px; color: #9b59b6;">М Total requerido:</h4>
                                <div class="ingredients-list">
                                    ${Object.entries(totalIngredients).map(([name, total]) => `
                                        <div class="ingredient-item">
                                            <span><strong>${name}</strong></span>
                                            <span><strong>${total.toFixed(2)} ${getUnit(name)}</strong></span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            formulaHTML = `<p style="color: #ff6b6b; margin-top: 20px;">锔 F贸rmula no encontrada para: ${formulaKey}</p>`;
                        }
                    }

                    const typeIcon = selectedProduct && selectedProduct.type === 'packaging' ? '' : '锔';

                    card.innerHTML = `
                        ${actionBadge}
                        <div class="product-title">${typeIcon} ${product.name}</div>
                        <div class="product-quantity">Cantidad: ${product.quantity} unidades</div>
                        <div style="color: #8a8ab3; font-size: 0.9em; margin-bottom: 15px;">
                             ${new Date(product.timestamp).toLocaleString('es-ES')}
                        </div>
                        ${product.fragrance ? `<div style="background: linear-gradient(90deg, rgba(155, 89, 182, 0.1), transparent); padding: 10px; border-radius: 10px; margin: 10px 0; border-left: 3px solid #9b59b6; color: #b3b3e6;"> ${product.fragrance}</div>` : ''}
                        ${formulaHTML}
                        <button class="btn btn-danger" onclick="removeProduct(${products.indexOf(product)})">
                            锔 Eliminar Local
                        </button>
                    `;
                    
                    container.appendChild(card);
                });
            });
        }

        // Eliminar producto
        function removeProduct(index) {
            if (confirm('驴Est谩 seguro de eliminar este registro LOCAL? (Esto NO afecta Google Sheets)')) {
                products.splice(index, 1);
                updateProductsList();
                updateTotals();
            }
        }

        // Actualizar totales
        function updateTotals(productsToCalculate = products) {
            const totalProducts = productsToCalculate.reduce((sum, product) => sum + product.quantity, 0);
            const rawMaterials = {};

            productsToCalculate.forEach(product => {
                const selectedProduct = allProducts.find(p => p.name === product.name.split(' (')[0]);
                
                if (selectedProduct && selectedProduct.type === 'packaging') {
                    const productName = selectedProduct.name;
                    
                    if (rawMaterials[productName]) {
                        rawMaterials[productName] += product.quantity;
                    } else {
                        rawMaterials[productName] = product.quantity;
                    }
                } else if (formulas[product.name]) {
                    formulas[product.name].forEach(ingredient => {
                        const totalNeeded = ingredient.quantity * product.quantity;
                        if (rawMaterials[ingredient.name]) {
                            rawMaterials[ingredient.name] += totalNeeded;
                        } else {
                            rawMaterials[ingredient.name] = totalNeeded;
                        }
                    });
                } else {
                    // Intentar buscar la f贸rmula con el nombre del producto base + presentaci贸n
                    const productBaseName = product.name.split(' (')[0];
                    const presentation = product.name.match(/\(([^)]+)\)/)?.[1] || '';
                    const formulaKey = `${productBaseName} (${presentation})`;
                    
                    if (formulas[formulaKey]) {
                        formulas[formulaKey].forEach(ingredient => {
                            const totalNeeded = ingredient.quantity * product.quantity;
                            if (rawMaterials[ingredient.name]) {
                                rawMaterials[ingredient.name] += totalNeeded;
                            } else {
                                rawMaterials[ingredient.name] = totalNeeded;
                            }
                        });
                    }
                }
            });

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalRawMaterials').textContent = Object.keys(rawMaterials).length;

            const breakdown = document.getElementById('rawMaterialsBreakdown');
            if (Object.keys(rawMaterials).length > 0) {
                const sortedMaterials = Object.entries(rawMaterials).sort((a, b) => b[1] - a[1]);
                
                breakdown.innerHTML = `
                    <h3 style="margin-top: 40px; margin-bottom: 25px; color: white;"> Desglose de Materia Prima Utilizada:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        ${sortedMaterials.map(([material, quantity]) => {
                            const selectedProduct = allProducts.find(p => p.name === material);
                            let unit;
                            
                            if (selectedProduct && selectedProduct.type === 'packaging') {
                                const firstPresentation = selectedProduct.presentations[0] || '';
                                unit = getUnitForPackaging(material, firstPresentation);
                            } else {
                                unit = getUnit(material);
                            }
                            
                            return `
                                <div class="total-item">
                                    <div class="total-value">${quantity.toFixed(2)}</div>
                                    <div class="total-label">${material} (${unit})</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                breakdown.innerHTML = '';
            }
        }

        // Inicializar cuando se carga la p谩gina
        document.addEventListener('DOMContentLoaded', function() {
            setupPrepareProductSearch();
            setupPackageProductSearch();
            setupPrepareFragranceSearch();
            updateProductsList();
            updateTotals();
        });
    </script>
</body>
</html>
