<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario - Productos Finalizados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0f0f23 75%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Part√≠culas flotantes animadas */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: linear-gradient(45deg, #9b59b6, #663399);
            border-radius: 50%;
            opacity: 0.6;
            animation: float 6s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 4px; height: 4px; left: 10%; animation-delay: 0s; animation-duration: 8s; }
        .particle:nth-child(2) { width: 6px; height: 6px; left: 20%; animation-delay: 1s; animation-duration: 7s; }
        .particle:nth-child(3) { width: 3px; height: 3px; left: 30%; animation-delay: 2s; animation-duration: 9s; }
        .particle:nth-child(4) { width: 5px; height: 5px; left: 40%; animation-delay: 0.5s; animation-duration: 6s; }
        .particle:nth-child(5) { width: 4px; height: 4px; left: 50%; animation-delay: 3s; animation-duration: 8s; }

        @keyframes float {
            0%, 100% { 
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10%, 90% {
                opacity: 0.6;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 1;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.5),
                0 0 0 1px rgba(155, 89, 182, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.5),
                0 0 20px rgba(155, 89, 182, 0.5);
            position: relative;
            z-index: 1;
        }

        .header p {
            position: relative;
            z-index: 1;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
            background: rgba(26, 26, 46, 0.7);
        }

        .section {
            margin-bottom: 50px;
            padding: 30px;
            background: linear-gradient(145deg, #2c2c54 0%, #1a1a2e 100%);
            border-radius: 20px;
            border: 1px solid rgba(155, 89, 182, 0.3);
            box-shadow: 
                0 15px 30px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.4),
                0 0 20px rgba(155, 89, 182, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .section h2 {
            color: #e6e6ff;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
        }

        .action-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .action-card.active {
            border-color: #9b59b6;
            box-shadow: 
                0 0 30px rgba(155, 89, 182, 0.5),
                inset 0 0 20px rgba(155, 89, 182, 0.1);
            transform: scale(1.02);
        }

        .action-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.3);
        }

        .action-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .action-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #e6e6ff;
            margin-bottom: 10px;
        }

        .action-description {
            color: #b3b3e6;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #b3b3e6;
            font-size: 1.1em;
        }

        input, select, button {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            color: #e6e6ff;
        }

        select {
            background: linear-gradient(145deg, #3c3c6e 0%, #2c2c54 100%);
            color: #e6e6ff;
        }

        select option {
            background: #2c2c54;
            color: #e6e6ff;
            padding: 10px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #9b59b6;
            box-shadow: 
                0 0 0 3px rgba(155, 89, 182, 0.2),
                0 0 20px rgba(155, 89, 182, 0.3);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: #8a8ab3;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 25px rgba(155, 89, 182, 0.4),
                0 0 20px rgba(155, 89, 182, 0.3);
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, #2c2c54 0%, #1e1e3f 100%);
            border: 2px solid #9b59b6;
            border-top: none;
            border-radius: 0 0 15px 15px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .dropdown-option {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
            color: #b3b3e6;
            transition: all 0.3s ease;
        }

        .dropdown-option:hover {
            background: linear-gradient(90deg, rgba(155, 89, 182, 0.2), rgba(155, 89, 182, 0.1));
            color: #e6e6ff;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-card {
            background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 
                0 8px 25px rgba(102, 51, 153, 0.4),
                0 0 0 1px rgba(155, 89, 182, 0.3);
        }

        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .product-card {
            background: linear-gradient(145deg, #2c2c54 0%, #1e1e3f 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(155, 89, 182, 0.2);
            transition: all 0.4s ease;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.4),
                0 0 30px rgba(155, 89, 182, 0.3);
        }

        .product-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #e6e6ff;
            margin-bottom: 15px;
        }

        .product-quantity {
            font-size: 1.2em;
            color: #9b59b6;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .totals-section {
            background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 50%, #7b1fa2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-top: 40px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .total-item {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .total-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .total-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #8a8ab3;
            font-style: italic;
            font-size: 1.1em;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8e24aa 0%, #9c27b0 50%, #7b1fa2 100%);
            color: white;
            width: auto;
            padding: 12px 20px;
            margin-top: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #9b59b6;
            animation: loading-spin 1s ease-in-out infinite;
        }

        @keyframes loading-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .products-list {
                grid-template-columns: 1fr;
            }
            
            .totals-grid {
                grid-template-columns: 1fr;
            }

            .action-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Part√≠culas flotantes -->
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Sistema de Inventario</h1>
            <p>Control de Productos Finalizados</p>
        </div>

        <div class="main-content">
            <!-- Estado de conexi√≥n -->
            <div class="status-card">
                <span>üîó</span>
                <span>Conectado a Google Sheets - Los datos se guardan autom√°ticamente</span>
            </div>

            <!-- Selector de Acci√≥n -->
            <div class="section">
                <h2>üéØ Seleccione una Acci√≥n</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Elija si desea preparar productos con f√≥rmula o empacar productos directos.</p>
                
                <div class="action-selector">
                    <div class="action-card" onclick="selectAction('prepare')">
                        <span class="action-icon">‚öóÔ∏è</span>
                        <div class="action-title">Preparar</div>
                        <div class="action-description">Productos con f√≥rmula que requieren preparaci√≥n y mezcla de ingredientes</div>
                    </div>
                    
                    <div class="action-card" onclick="selectAction('package')">
                        <span class="action-icon">üì¶</span>
                        <div class="action-title">Empacar</div>
                        <div class="action-description">Productos de empaque directo en relaci√≥n 1:1</div>
                    </div>
                </div>
            </div>

            <!-- Formulario de preparaci√≥n -->
            <div class="section form-container" id="prepareForm">
                <h2>‚öóÔ∏è Preparar Productos</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Complete los campos para registrar la preparaci√≥n de productos con f√≥rmula.</p>
                
                <div class="form-group">
                    <label for="prepareProductSearch">Producto a Preparar:</label>
                    <div style="position: relative;">
                        <input type="text" id="prepareProductSearch" placeholder="Haga clic para seleccionar producto..." autocomplete="off" readonly required>
                        <div id="prepareProductDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPrepareProduct">
                </div>
                
                <div class="form-group">
                    <label for="prepareProductPresentation">Presentaci√≥n:</label>
                    <select id="prepareProductPresentation" required>
                        <option value="">Primero seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group" id="prepareFragranceGroup" style="display: none;">
                    <label for="prepareFragranceSearch">Fragancia:</label>
                    <div style="position: relative;">
                        <input type="text" id="prepareFragranceSearch" placeholder="Haga clic para seleccionar fragancia..." autocomplete="off" readonly>
                        <div id="prepareFragranceDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPrepareFragrance">
                </div>
                
                <div class="form-group">
                    <label for="prepareProductQuantity">Cantidad a Preparar:</label>
                    <input type="number" id="prepareProductQuantity" placeholder="¬øCu√°ntas unidades se van a preparar?" min="1" required>
                </div>
                
                <div style="display: flex; justify-content: center;">
                    <button class="btn" onclick="addPrepareProduct()">
                        <span id="prepareSaveButtonText">Registrar Preparaci√≥n</span>
                    </button>
                </div>
                
                <div id="prepareSaveStatus" style="margin-top: 20px;"></div>
            </div>

            <!-- Formulario de empaque -->
            <div class="section form-container" id="packageForm">
                <h2>üì¶ Empacar Productos</h2>
                <p style="color: #8a8ab3; margin-bottom: 25px; text-align: center;">Complete los campos para registrar el empaque de productos directos.</p>
                
                <div class="form-group">
                    <label for="packageProductSearch">Producto a Empacar:</label>
                    <div style="position: relative;">
                        <input type="text" id="packageProductSearch" placeholder="Haga clic para seleccionar producto..." autocomplete="off" readonly required>
                        <div id="packageProductDropdown" class="dropdown"></div>
                    </div>
                    <input type="hidden" id="selectedPackageProduct">
                </div>
                
                <div class="form-group">
                    <label for="packageProductPresentation">Presentaci√≥n:</label>
                    <select id="packageProductPresentation" required>
                        <option value="">Primero seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="packageProductQuantity">Cantidad a Empacar:</label>
                    <input type="number" id="packageProductQuantity" placeholder="¬øCu√°ntas unidades se van a empacar?" min="1" required>
                </div>
                
                <div style="display: flex; justify-content: center;">
                    <button class="btn" onclick="addPackageProduct()">
                        <span id="packageSaveButtonText">Registrar Empaque</span>
                    </button>
                </div>
                
                <div id="packageSaveStatus" style="margin-top: 20px;"></div>
            </div>

            <!-- Lista de productos -->
            <div class="section">
                <h2>üìä Producci√≥n Registrada</h2>
                <div id="productsList" class="products-list">
                    <div class="empty-state">
                        <p>No hay producci√≥n registrada. Seleccione una acci√≥n arriba para empezar.</p>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="totals-section">
                <h2>üìä Resumen Total de Producci√≥n</h2>
                <div class="totals-grid">
                    <div class="total-item">
                        <div class="total-value" id="totalProducts">0</div>
                        <div class="total-label">Productos Finalizados</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="totalPrepared">0</div>
                        <div class="total-label">Productos Preparados</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="totalPackaged">0</div>
                        <div class="total-label">Productos Empacados</div>
                    </div>
                </div>
                <div id="productBreakdown"></div>
            </div>
        </div>
    </div>

    <script>
        // URL fija de Google Sheets
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwKijWeDxf279_nBRjFcBfJTEmJc4150kRFIMN8BsJX7z6TaAv_4djupBhomOrpA48-Zw/exec';
        
        // Variables globales
        let products = [];
        let dailyProduction = {};
        let currentAction = null;

        // Lista de productos disponibles
        const allProducts = [
            // Productos con f√≥rmulas
            { name: "AMBIENTADOR CONCENTRADO", type: "formula", presentations: ["1L", "1 GAL√ìN"], needsFragrance: true },
            { name: "SILICONA", type: "formula", presentations: ["60ml"], needsFragrance: false },
            { name: "LLANT√çN", type: "formula", presentations: ["1L", "20L"], needsFragrance: false },
            { name: "LIMPIDO AL 5%", type: "formula", presentations: ["1 GAL√ìN", "20L"], needsFragrance: false },
            { name: "DESENGRASANTE", type: "formula", presentations: ["1 GAL√ìN", "20L"], needsFragrance: false },
            { name: "DETERGENTE DE MANOS", type: "formula", presentations: ["1L", "20L"], needsFragrance: false },
            { name: "LIMPIAVIDRIOS", type: "formula", presentations: ["1L", "1 GAL√ìN", "20L"], needsFragrance: false },
            { name: "DESINFECTANTE", type: "formula", presentations: ["1L", "1 GAL√ìN", "20L"], needsFragrance: true },
            { name: "DESINFECTANTE CANELA/LIM√ìN", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "RESTAURADOR DE PARTES NEGRAS", type: "formula", presentations: ["1L", "1 GAL√ìN"], needsFragrance: false },
            { name: "DETERGENTE L√çQUIDO", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "SHAMPOO POLARIZADO", type: "formula", presentations: ["20L"], needsFragrance: false },
            { name: "SHAMPOO VEH√çCULO", type: "formula", presentations: ["40L", "80L", "160L"], needsFragrance: false },
            
            // Productos de empaque
            { name: "√Åcido n√≠trico", type: "packaging", presentations: ["Gal√≥n"], needsFragrance: false },
            { name: "√Åcido sulf√≥nico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Alcohol cet√≠lico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Alcohol et√≠lico", type: "packaging", presentations: ["Litro", "Gal√≥n", "20Lts"], needsFragrance: false },
            { name: "Alcohol desodorizado", type: "packaging", presentations: ["Litro"], needsFragrance: false },
            { name: "Alcohol prop√≠lico", type: "packaging", presentations: ["Gal√≥n", "Litro"], needsFragrance: false },
            { name: "Beta√≠na", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Butil glicol", type: "packaging", presentations: ["Litro", "1/2 Litro"], needsFragrance: false },
            { name: "Cocoamida", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Creolina", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Dodigen", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Genapol 70%", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Glicerina", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Hipoclorito de sodio", type: "packaging", presentations: ["20Lts", "Gal√≥n", "Litro", "Kg"], needsFragrance: false },
            { name: "Nonil", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Procide", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Rinsol", type: "packaging", presentations: ["Kg", "1/2 Kg"], needsFragrance: false },
            { name: "Silicona antiespumante", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Silicona emulsi√≥n", type: "packaging", presentations: ["Kg", "1/2 Kg"], needsFragrance: false },
            { name: "Soda", type: "packaging", presentations: ["1/2 Kg", "Kg"], needsFragrance: false },
            { name: "Sensableach", type: "packaging", presentations: ["Litro"], needsFragrance: false },
            { name: "Varsol", type: "packaging", presentations: ["1/2 Litro", "Gal√≥n", "Litro"], needsFragrance: false },
            { name: "Tpf (tripolifosfato)", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "√Åcido c√≠trico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "√Åcido ox√°lico", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Antiincrustante", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Bicarbonato de sodio", type: "packaging", presentations: ["Kg"], needsFragrance: false },
            { name: "Bisulfito de sodio", type: "packaging", presentations: ["Kg"], needsFragrance: false }
        ];

        // Lista de fragancias
        const fragrances = [
            "Fragancia Ailyn",
            "Fragancia Algod√≥n",
            "Fragancia Bamboo",
            "Fragancia Brisa Del Mar",
            "Fragancia Brisa Del Campo",
            "Fragancia Brisa Marina",
            "Fragancia Caf√©",
            "Fragancia Canela",
            "Fragancia Carro Nuevo",
            "Fragancia Cherry (Cereza)",
            "Fragancia Chicle",
            "Fragancia Citronela",
            "Fragancia Durazno",
            "Fragancia Flor De Amoha",
            "Fragancia Fresa",
            "Fragancia Frutal",
            "Fragancia Jardin",
            "Fragancia Lavanda Fabulosa",
            "Fragancia Lima Limon",
            "Fragancia Liquid Touch",
            "Fragancia Limon Peel",
            "Fragancia Magic Flowers",
            "Fragancia Mandarina",
            "Fragancia Manzana",
            "Fragancia Maracuya",
            "Fragancia Patilla Melon",
            "Fragancia Pino Navidad",
            "Fragancia Pi√±a",
            "Fragancia Rosa",
            "Fragancia Sierra Nevada",
            "Fragancia Talco",
            "Fragancia Uva",
            "Fragancia Vainilla"
        ];

        // Funci√≥n para seleccionar acci√≥n
        function selectAction(action) {
            currentAction = action;
            
            // Remover clase active de todas las tarjetas
            document.querySelectorAll('.action-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Ocultar todos los formularios
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.remove('active');
            });
            
            if (action === 'prepare') {
                document.querySelector('.action-card:first-child').classList.add('active');
                document.getElementById('prepareForm').classList.add('active');
            } else if (action === 'package') {
                document.querySelector('.action-card:last-child').classList.add('active');
                document.getElementById('packageForm').classList.add('active');
            }
        }

        // Configurar selector de productos para PREPARAR
        function setupPrepareProductSearch() {
            const searchInput = document.getElementById('prepareProductSearch');
            const dropdown = document.getElementById('prepareProductDropdown');
            const hiddenInput = document.getElementById('selectedPrepareProduct');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                
                const formulaProducts = allProducts.filter(p => p.type === 'formula');
                
                formulaProducts.forEach(product => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = product.name;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = product.name;
                        hiddenInput.value = product.name;
                        dropdown.style.display = 'none';
                        updatePreparePresentations();
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Configurar selector de productos para EMPACAR
        function setupPackageProductSearch() {
            const searchInput = document.getElementById('packageProductSearch');
            const dropdown = document.getElementById('packageProductDropdown');
            const hiddenInput = document.getElementById('selectedPackageProduct');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                
                const packagingProducts = allProducts.filter(p => p.type === 'packaging');
                
                packagingProducts.forEach(product => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = product.name;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = product.name;
                        hiddenInput.value = product.name;
                        dropdown.style.display = 'none';
                        updatePackagePresentations();
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Configurar selector de fragancias
        function setupPrepareFragranceSearch() {
            const searchInput = document.getElementById('prepareFragranceSearch');
            const dropdown = document.getElementById('prepareFragranceDropdown');
            const hiddenInput = document.getElementById('selectedPrepareFragrance');

            searchInput.addEventListener('focus', function() {
                dropdown.innerHTML = '';
                fragrances.forEach(fragrance => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = fragrance;
                    
                    option.addEventListener('click', function() {
                        searchInput.value = fragrance;
                        hiddenInput.value = fragrance;
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(option);
                });
                dropdown.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Actualizar presentaciones para PREPARAR
        function updatePreparePresentations() {
            const selectedProductName = document.getElementById('selectedPrepareProduct').value;
            const presentationSelect = document.getElementById('prepareProductPresentation');
            const fragranceGroup = document.getElementById('prepareFragranceGroup');
            
            presentationSelect.innerHTML = '';
            
            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (selectedProduct && selectedProduct.needsFragrance) {
                fragranceGroup.style.display = 'block';
            } else {
                fragranceGroup.style.display = 'none';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
            }
            
            if (!selectedProduct) {
                presentationSelect.innerHTML = '<option value="">Primero seleccione un producto</option>';
                return;
            }
            
            const availablePresentations = selectedProduct.presentations || [];
            
            if (availablePresentations.length === 0) {
                presentationSelect.innerHTML = '<option value="">No hay presentaciones disponibles</option>';
                return;
            }
            
            presentationSelect.innerHTML = '<option value="">Seleccione una presentaci√≥n</option>';
            
            availablePresentations.forEach(presentation => {
                const option = document.createElement('option');
                option.value = presentation;
                option.textContent = presentation;
                presentationSelect.appendChild(option);
            });
        }

        // Actualizar presentaciones para EMPACAR
        function updatePackagePresentations() {
            const selectedProductName = document.getElementById('selectedPackageProduct').value;
            const presentationSelect = document.getElementById('packageProductPresentation');
            
            presentationSelect.innerHTML = '';
            
            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (!selectedProduct) {
                presentationSelect.innerHTML = '<option value="">Primero seleccione un producto</option>';
                return;
            }
            
            const availablePresentations = selectedProduct.presentations || [];
            
            if (availablePresentations.length === 0) {
                presentationSelect.innerHTML = '<option value="">No hay presentaciones disponibles</option>';
                return;
            }
            
            presentationSelect.innerHTML = '<option value="">Seleccione una presentaci√≥n</option>';
            
            availablePresentations.forEach(presentation => {
                const option = document.createElement('option');
                option.value = presentation;
                option.textContent = presentation;
                presentationSelect.appendChild(option);
            });
        }

        // Funci√≥n simplificada para enviar datos a Google Sheets
        async function sendToGoogleSheets(productData) {
            const currentTime = new Date().toLocaleTimeString('es-ES');

            // Crear registro simplificado - solo producto, presentaci√≥n y cantidad
            const record = {
                date: productData.date,
                time: currentTime,
                employee: 'Sistema',
                product: productData.name.split(' (')[0], // Nombre del producto sin presentaci√≥n
                presentation: productData.name.match(/\(([^)]+)\)/)?.[1] || '', // Solo la presentaci√≥n
                fragrance: productData.fragrance || 'N/A',
                quantity: productData.quantity,
                action: productData.action // 'prepare' o 'package'
            };

            // Simular delay realista de red
            const delay = Math.random() * 1000 + 500; // 0.5-1.5 segundos
            await new Promise(resolve => setTimeout(resolve, delay));

            const response = await fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ record: record })
            });

            return { success: true, record: record };
        }

        // Agregar producto PREPARAR
        async function addPrepareProduct() {
            const selectedProductName = document.getElementById('selectedPrepareProduct').value;
            const presentation = document.getElementById('prepareProductPresentation').value;
            const quantity = parseInt(document.getElementById('prepareProductQuantity').value);
            const selectedFragrance = document.getElementById('selectedPrepareFragrance').value;
            const date = new Date().toISOString().split('T')[0];

            if (!selectedProductName || !presentation || !quantity || quantity <= 0) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }

            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            if (selectedProduct && selectedProduct.needsFragrance && !selectedFragrance) {
                alert('Por favor, seleccione una fragancia para este producto.');
                return;
            }
            
            let fullProductName = `${selectedProductName} (${presentation})`;
            if (selectedFragrance) {
                fullProductName += ` - ${selectedFragrance}`;
            }
            
            const productRecord = {
                name: fullProductName,
                quantity: quantity,
                date: date,
                timestamp: new Date().toISOString(),
                employee: 'Sistema',
                fragrance: selectedFragrance || null,
                productType: selectedProduct.type,
                action: 'prepare'
            };

            const saveButton = document.getElementById('prepareSaveButtonText');
            const statusDiv = document.getElementById('prepareSaveStatus');
            
            saveButton.innerHTML = '<span class="loading-spinner"></span> Guardando...';
            statusDiv.innerHTML = '<div style="color: #9b59b6;">üì§ Enviando datos a Google Sheets...</div>';

            try {
                await sendToGoogleSheets(productRecord);
                
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                // Limpiar formulario
                document.getElementById('prepareProductSearch').value = '';
                document.getElementById('selectedPrepareProduct').value = '';
                document.getElementById('prepareProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('prepareProductQuantity').value = '';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
                document.getElementById('prepareFragranceGroup').style.display = 'none';
                
                saveButton.textContent = '¬°Guardado!';
                statusDiv.innerHTML = `<div style="color: #9b59b6;">‚úì ${fullProductName} preparado exitosamente: ${quantity} unidades</div>`;
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Preparaci√≥n';
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                saveButton.textContent = '‚ö†Ô∏è Guardado Local';
                statusDiv.innerHTML = `<div style="color: #ff9500;">‚ö†Ô∏è Error conectando con Google Sheets. Datos guardados localmente.</div>`;
                
                // Limpiar formulario
                document.getElementById('prepareProductSearch').value = '';
                document.getElementById('selectedPrepareProduct').value = '';
                document.getElementById('prepareProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('prepareProductQuantity').value = '';
                document.getElementById('prepareFragranceSearch').value = '';
                document.getElementById('selectedPrepareFragrance').value = '';
                document.getElementById('prepareFragranceGroup').style.display = 'none';
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Preparaci√≥n';
                }, 3000);
            }
        }

        // Agregar producto EMPACAR - AHORA TAMBI√âN ENV√çA A GOOGLE SHEETS
        async function addPackageProduct() {
            const selectedProductName = document.getElementById('selectedPackageProduct').value;
            const presentation = document.getElementById('packageProductPresentation').value;
            const quantity = parseInt(document.getElementById('packageProductQuantity').value);
            const date = new Date().toISOString().split('T')[0];

            if (!selectedProductName || !presentation || !quantity || quantity <= 0) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }

            const selectedProduct = allProducts.find(p => p.name === selectedProductName);
            
            let fullProductName = `${selectedProductName} (${presentation})`;
            
            const productRecord = {
                name: fullProductName,
                quantity: quantity,
                date: date,
                timestamp: new Date().toISOString(),
                employee: 'Sistema',
                fragrance: null,
                productType: selectedProduct.type,
                action: 'package'
            };

            const saveButton = document.getElementById('packageSaveButtonText');
            const statusDiv = document.getElementById('packageSaveStatus');
            
            saveButton.innerHTML = '<span class="loading-spinner"></span> Guardando...';
            statusDiv.innerHTML = '<div style="color: #9b59b6;">üì¶ Enviando datos a Google Sheets...</div>';

            try {
                // AHORA S√ç ENV√çA A GOOGLE SHEETS
                await sendToGoogleSheets(productRecord);
                
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                // Limpiar formulario
                document.getElementById('packageProductSearch').value = '';
                document.getElementById('selectedPackageProduct').value = '';
                document.getElementById('packageProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('packageProductQuantity').value = '';
                
                saveButton.textContent = '¬°Empacado!';
                statusDiv.innerHTML = `<div style="color: #9b59b6;">‚úì ${fullProductName} empacado exitosamente: ${quantity} unidades</div>`;
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Empaque';
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                // Si falla el env√≠o a Google Sheets, guardar localmente
                products.push(productRecord);
                
                if (!dailyProduction[date]) {
                    dailyProduction[date] = [];
                }
                dailyProduction[date].push(productRecord);

                updateProductsList();
                updateTotals();
                
                saveButton.textContent = '‚ö†Ô∏è Guardado Local';
                statusDiv.innerHTML = `<div style="color: #ff9500;">‚ö†Ô∏è Error conectando con Google Sheets. Datos guardados localmente.</div>`;
                
                // Limpiar formulario
                document.getElementById('packageProductSearch').value = '';
                document.getElementById('selectedPackageProduct').value = '';
                document.getElementById('packageProductPresentation').innerHTML = '<option value="">Primero seleccione un producto</option>';
                document.getElementById('packageProductQuantity').value = '';
                
                setTimeout(() => {
                    saveButton.textContent = 'Registrar Empaque';
                }, 3000);
            }
        }

        // Actualizar lista de productos
        function updateProductsList(productsToShow = products) {
            const container = document.getElementById('productsList');
            
            if (productsToShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay producci√≥n registrada. Seleccione una acci√≥n arriba para empezar.</p></div>';
                return;
            }

            container.innerHTML = '';
            
            const productsByDate = {};
            productsToShow.forEach(product => {
                if (!productsByDate[product.date]) {
                    productsByDate[product.date] = [];
                }
                productsByDate[product.date].push(product);
            });

            Object.keys(productsByDate).sort().reverse().forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.style.cssText = `
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #663399 0%, #9b59b6 50%, #8e44ad 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    margin: 25px 0 15px 0;
                    font-size: 1.3em;
                    font-weight: 600;
                    text-align: center;
                `;
                dateHeader.textContent = `üìÖ ${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
                container.appendChild(dateHeader);

                productsByDate[date].forEach((product, index) => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    
                    let actionBadge = '';
                    let typeIcon = '';
                    
                    if (product.action === 'prepare') {
                        actionBadge = '<div style="display: inline-block; background: linear-gradient(45deg, #663399, #9b59b6); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px;">‚öóÔ∏è PREPARADO</div>';
                        typeIcon = '‚öóÔ∏è';
                    } else if (product.action === 'package') {
                        actionBadge = '<div style="display: inline-block; background: linear-gradient(45deg, #8e24aa, #9c27b0); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px;">üì¶ EMPACADO</div>';
                        typeIcon = 'üì¶';
                    }

                    const productName = product.name.split(' (')[0];
                    const presentation = product.name.match(/\(([^)]+)\)/)?.[1] || '';
                    const actionText = product.action === 'prepare' ? 'Preparaci√≥n' : 'Empaque';
                    
                    card.innerHTML = `
                        ${actionBadge}
                        <div class="product-title">${typeIcon} ${productName}</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div class="product-quantity">${product.quantity} unidades</div>
                            <div style="background: #663399; color: white; padding: 4px 8px; border-radius: 8px; font-size: 0.8em;">
                                ${presentation}
                            </div>
                        </div>
                        
                        <div style="color: #8a8ab3; font-size: 0.9em; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                            <span>‚è∞</span>
                            <span>${new Date(product.timestamp).toLocaleString('es-ES')}</span>
                        </div>
                        
                        ${product.fragrance ? `
                            <div style="background: linear-gradient(90deg, rgba(155, 89, 182, 0.15), transparent); 
                                        padding: 12px; border-radius: 10px; margin-bottom: 20px; 
                                        border-left: 4px solid #9b59b6; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üå∏</span>
                                <span style="color: #e6e6ff; font-weight: 500;">${product.fragrance}</span>
                            </div>
                        ` : ''}
                        
                        <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)); 
                                    border: 1px solid rgba(76, 175, 80, 0.3); 
                                    padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 1.2em;">‚úÖ</span>
                                <strong style="color: #4CAF50; font-size: 1em;">Enviado a Google Sheets</strong>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; font-size: 0.9em;">
                                <span style="color: #9b59b6; font-weight: 600;">Producto:</span>
                                <span style="color: #e6e6ff;">${productName}</span>
                                
                                <span style="color: #9b59b6; font-weight: 600;">Presentaci√≥n:</span>
                                <span style="color: #e6e6ff;">${presentation}</span>
                                
                                <span style="color: #9b59b6; font-weight: 600;">Cantidad:</span>
                                <span style="color: #e6e6ff;">${product.quantity} unidades</span>
                                
                                <span style="color: #9b59b6; font-weight: 600;">Tipo:</span>
                                <span style="color: #e6e6ff;">${actionText}</span>
                                
                                ${product.fragrance ? `
                                    <span style="color: #9b59b6; font-weight: 600;">Fragancia:</span>
                                    <span style="color: #e6e6ff;">${product.fragrance}</span>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(76, 175, 80, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; color: #4CAF50; font-size: 0.8em;">
                                    <span>üöÄ</span>
                                    <span>Datos sincronizados en tiempo real (1-3 segundos)</span>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="removeProduct(${products.indexOf(product)})" 
                                style="font-size: 0.9em; padding: 10px 16px;">
                            üóëÔ∏è Eliminar registro local
                        </button>
                    `;
                    
                    container.appendChild(card);
                });
            });
        }

        // Eliminar producto
        function removeProduct(index) {
            if (confirm('¬øEst√° seguro de eliminar este registro LOCAL? (Esto NO afecta Google Sheets)')) {
                products.splice(index, 1);
                updateProductsList();
                updateTotals();
            }
        }

        // Actualizar totales
        function updateTotals(productsToCalculate = products) {
            const totalProducts = productsToCalculate.reduce((sum, product) => sum + product.quantity, 0);
            const preparedProducts = productsToCalculate.filter(p => p.action === 'prepare').reduce((sum, product) => sum + product.quantity, 0);
            const packagedProducts = productsToCalculate.filter(p => p.action === 'package').reduce((sum, product) => sum + product.quantity, 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalPrepared').textContent = preparedProducts;
            document.getElementById('totalPackaged').textContent = packagedProducts;

            // Crear desglose por productos
            const productBreakdown = {};
            productsToCalculate.forEach(product => {
                const productName = product.name.split(' (')[0];
                if (productBreakdown[productName]) {
                    productBreakdown[productName] += product.quantity;
                } else {
                    productBreakdown[productName] = product.quantity;
                }
            });

            const breakdown = document.getElementById('productBreakdown');
            if (Object.keys(productBreakdown).length > 0) {
                const sortedProducts = Object.entries(productBreakdown).sort((a, b) => b[1] - a[1]);
                
                breakdown.innerHTML = `
                    <h3 style="margin-top: 40px; margin-bottom: 25px; color: white;">üìä Desglose por Productos:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        ${sortedProducts.map(([productName, quantity]) => `
                            <div class="total-item">
                                <div class="total-value">${quantity}</div>
                                <div class="total-label">${productName}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                breakdown.innerHTML = '';
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setupPrepareProductSearch();
            setupPackageProductSearch();
            setupPrepareFragranceSearch();
            updateProductsList();
            updateTotals();
        });
    </script>
</body>
</html>
